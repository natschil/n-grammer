<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
	<meta charset='utf-8'/> 
	<style>
		table
		{
			margin-right: 10px;
			font-family: arial
		}
		table, th,td
		{
			border: 1px solid grey;
		}
		td
		{
			width: 0%;
		}

		#actions_table
		{
			float:center;
		}

		#all_indexes_table
		{
			float: left;
		}
		#results_area td
		{
			width:100%;
			border: none;
		}
	</style>
<title>
	Welcome!
</title>
<script>
	"use strict;"

	var query_folder = "";
	var query_type = "search";
	var notification_type = "web";

	var $ = function(value)
	{
		return document.getElementById(value);
	}
	window.onload = function()
	{
		var all_indexes_request = new XMLHttpRequest;
		all_indexes_request.onload = function()
		{
			all_indexes_request.responseText.split("\n").forEach(
				function(entry)
				{
					if(entry[0] == "/")				
					{
						var newTextNode = document.createTextNode(entry);
						var newlineNode = document.createElement("br");
						$("error_log").appendChild(newTextNode);
						$("error_log").appendChild(newlineNode);
					}else
					{
						//Empty the table of indexes:	
						try
						{
							var list_all_result = JSON.parse(entry);
						}catch(e)
						{
							if(entry)
							{
								var newTextNode = docuement.createTextNode(entry);
								var newlineNode = document.createElement("br");
								$("error_log").appendChild(newTextNode);
								$("error_log").appendChild(newlineNode);
							}
						}
						for( var i in list_all_result)
						{
							var first_row = document.createElement("tr");
							var first_row_first_col = first_row.appendChild(document.createElement("td"));
							var radio_button = first_row_first_col.appendChild(document.createElement("input"));
							radio_button.type="radio";
							radio_button.name = "select_corpus";
							radio_button.value = i;
							radio_button.checked = true;
							query_folder = i;
							first_row_first_col.appendChild(document.createTextNode(i));

							var first_row_second_col = first_row.appendChild(document.createElement("td"));
							for(var ngramsize in list_all_result[i])
							{
								var header_text_node = document.createElement("h6");
								var header_text_node_contents = document.createTextNode(ngramsize+"-grams");
								header_text_node.appendChild(header_text_node_contents);
								first_row_second_col.appendChild(header_text_node);
								for(var attribute_name in list_all_result[i][ngramsize])
								{
									if(["Filename","WorldlengthStatsExist","Numwords"].indexOf(attribute_name) > -1)
									{
										first_row_second_col.appendChild(document.createTextNode(
										"\u00A0\u00A0\u00A0" + attribute_name + ":\u00A0\u00A0" + list_all_result[i][ngramsize][attribute_name]
										));
										first_row_second_col.appendChild(document.createElement("br"));
									}else if(["InvertedIndexes","Indexes"].indexOf(attribute_name) > -1)
									{
										first_row_second_col.appendChild(document.createTextNode(
											"\u00A0\u00A0\u00A0" + attribute_name
										));
										first_row_second_col.appendChild(document.createElement("br"));
										for(var index in list_all_result[i][ngramsize][attribute_name])
										{
											first_row_second_col.appendChild(document.createTextNode(
											"\u00A0\u00A0\u00A0" + "\u00A0\u00A0\u00A0" + index
											));
											first_row_second_col.appendChild(document.createElement("br"));
										}
									}
								}
							}

							radio_button.onclick = function()
							{
								query_folder = this.value;					
							}

							$("all_indexes_table").appendChild(first_row);
						}
					}
				}
				);
		};
		all_indexes_request.open("GET","/cgi-bin/ngramanalysis-wrapper.pl?action=list_all");
		all_indexes_request.send(null);

		$("run_query").onclick = function()
		{
			var query_request = new XMLHttpRequest;
			query_request.onload = function()
			{
				var local_search_string = $("search_string").value;
				if(query_type != "search")
					local_search_string = "";
				local_search_string = local_search_string.replace("[","");
				local_search_string = local_search_string.replace("]","");
				var lineNode = document.createElement("tr");
				lineNode.appendChild(document.createElement("td"));
				lineNode.firstChild.setAttribute("colspan",2);
				lineNode.firstChild.appendChild(document.createElement("hr"));
				lineNode.firstChild.firstChild.setAttribute("color","orange");
				results_area.appendChild(lineNode);
				query_request.responseText.split("\n").forEach(
					function(cur)
					{
						if(cur[0] == "/")
						{
							var currentTextNode = document.createTextNode(cur);
							$("error_log").appendChild(currentTextNode);
							$("error_log").appendChild(document.createElement("br"));
						}else
						{
							var re = /^(.+)\t([0-9]+)$/;
							if(cur.match(re))
							{
								var currentResultsNode = document.createElement("tr");
								currentResultsNode.appendChild(document.createElement("td"));
								currentResultsNode.appendChild(document.createElement("td"));

								var ngram = RegExp.$1;
								var frequency = RegExp.$2;
								if((ngram.indexOf("|") != -1) && local_search_string)
								{
									var words = ngram.split(" ");
									var new_words = [];
									var search_string_words = local_search_string.split(" ");
									for(var wordIndex in words)
									{
										var current_word = words[wordIndex];
										var current_search_word = search_string_words[wordIndex];

										if((current_search_word.indexOf("|") != -1)|| (current_word === "$"))
										{
											new_words.push(current_word);
										}else
										{
											if(current_word.match(/(^[^\|]+)\|([^\|]+)\|([^\|]+)$/))
												new_words.push(RegExp.$3);
											else
											{
												$("error_log").appendChild(document.createTextNode(
													"Error in web interface"));
												$("error_log").appendChild(document.createElement("br"));
											}
										}
									}
									ngram = new_words.join(" ");
								}

								currentResultsNode.firstChild.appendChild(
									document.createTextNode(ngram)
									);
								currentResultsNode.firstChild.nextSibling.appendChild(
									document.createTextNode(frequency)
									);
								$("results_area").appendChild(currentResultsNode);

							}else
							{
								var currentResultsNode = document.createElement("tr");
								currentResultsNode.appendChild(document.createElement("td"));
								currentResultsNode.appendChild(document.createElement("td"));
								currentResultsNode.firstChild.appendChild(
									document.createTextNode(cur)
									);
								currentResultsNode.firstChild.setAttribute("colspan",2);
								$("results_area").appendChild(currentResultsNode);
							}
						}
					}
					);
			}
			var url ="/cgi-bin/ngramanalysis-wrapper.pl?";
			url += "folder=" + encodeURIComponent(query_folder);
			url += "&action=" + encodeURIComponent(query_type);
			switch(query_type)
			{
				case "entropy_of":
				case "search":
					url+= "&search_string=" + encodeURIComponent($("search_string").value);
				break;
				case "get_top":
					url+="&ngramsize=" + encodeURIComponent($("ngram_number_get_top").value);
					url+="&howmany=" + encodeURIComponent($("howmany").value);
				break;
				case "view_wordlength_stats":
					url+="&ngramsize=" + encodeURIComponent($("ngram_number_wordlength_stats").value);
				break;
			}

			url+="&notification_type=" + encodeURIComponent(notification_type);
			if(notification_type == "email")
			{
				url +="&email_address=" + encodeURIComponent($("email_input").value);
			}
			query_request.open("get",url);
			query_request.send(null);
			var newTextNode = document.createTextNode("Sent request, waiting for response... (this might take a while)");
			$("error_log").appendChild(newTextNode);
			$("error_log").appendChild(document.createElement("br"));
		}

		for(var i in $("actions_part_of_table").getElementsByTagName("tr"))
		{
			var updateQueryType = function()
			{
				for(var j in $("params_part_of_table").getElementsByTagName("tr"))
				{
					if($("params_part_of_table").getElementsByTagName("tr")[j].style)
						$("params_part_of_table").getElementsByTagName("tr")[j].style.visibility = "collapse";
				}

				if(this.value != "entropy_of")
					$(this.value + "_param_row").style.visibility = "visible";
				else
					$("search_param_row").style.visibility = "visible";
				query_type = this.value;

			};
			if($("actions_part_of_table").getElementsByTagName("tr")[i].getElementsByTagName)
				$("actions_part_of_table").getElementsByTagName("tr")[i].getElementsByTagName("input")[0].onclick = updateQueryType;
		}

		$("notification_web").onclick = function()
		{
			notification_type = "web";
		}
		$("notification_email").onclick = function()
		{
			notification_type = "email";
		}

		$("clear_results_area").onclick = function()
		{
			while($("results_area").firstChild)
				$("results_area").removeChild($("results_area").firstChild);
			while($("error_log").firstChild)
				$("error_log").removeChild($("error_log").firstChild);
		}
	};
</script>
</head>
<body>
	<table id="all_indexes_table">
		<th>Index Name </th>
		<th>Details</th>
	</table>
	<table id="actions_table">
		<th>Action</th>
		<tbody id="actions_part_of_table">
		<tr><td><input type="radio" name="action_result" value="search" checked />Search(*)</td></tr>
		<tr><td><input type="radio" name="action_result" value="entropy_of" />Entropy (**)</td></tr>
		<tr><td><input type="radio" name="action_result" value="get_top"/>Show most frequent n-grams</td></tr>
		<tr><td><input type="radio" name="action_result" value="view_wordlength_stats"/>Show wordlength statistics (in utf8 code units)</td></tr>
		</tbody>
		<tr><td>
<pre>
(*) Entering a search string like "Piece * cake" would probably find
	"piece of cake" in an english-language corpus.

    For POS corpora, you can enter search strings like "[*|piece|*] of cake",
    which would find n-grams like
	"piece of cake"
    or
	"pieces of cake".
    The POS notation above takes the form [type|lemma|word], where an asterisk
    means a wildcard.

    Note that for POS corpora, the output of words from the search string not
    in the [foo|bar|baz] notation is simplified to only show the word. Hence searching
    POS corpora without using the square bracket notation may result in duplicate outputs.
    For words with the search string in square bracket notation, each word of the result
    of a search on a POS corpus has the form type|lemma|word in the result.

    An output of "$" refers to a "null-word". This is generally either the start or end of
    the corpus, a word that is longer than MAX_WORD_SIZE characters (or variations of this for
    POS corpora), a word starting with &lt; for POS corpora (for xml tags which separate files)
    or the special string ---END.OF.DOCUMENT---. Note that two "$"s in succession do not mean
    that there were two null-words as all null-words are treated as if they were arbitarily long
    sequences of null-words. "$" can be used in some search strings both in POS an non-POS corpora.

(**) Use a search string with wildcards to determine the entropy of the wildcards (in bits).
</pre>
		</td></tr>
		<th> Parameters </th>
		<tbody id="params_part_of_table">
		<tr id="search_param_row"><td >Search String:<input type="text" id="search_string"></td> </tr>
		<tr id="get_top_param_row" style="visibility:collapse"><td>
				N-gram number (i.e. 3 for 3-grams)<input type="text" id="ngram_number_get_top"><br/>
				Number of results to show: <input type="text" id="howmany"/>
		</td> </tr>
		<tr id="view_wordlength_stats_param_row" style="visibility:collapse"><td>N-gram number (i.e. 3 for 3-grams)<input type="text" id="ngram_number_wordlength_stats"></td> </tr>
		</tbody>
		<th> Notification Type </th>
		<tr><td><input type="radio" name="notification_type" value="web" checked="true" id="notification_web"/>On this website (results will appear below)</td></tr>
		<tr><td><input type="radio" name="notification_type" value="email" id="notification_email"/>Per email to <input type="text" id="email_input"/></td></tr>
		<tr><td><input type="button" value="Go!" id="run_query"/></td></tr>
		<th> Log </th>
		<tr><td id="error_log"/></tr>
		<th> Results</th>
		<tr><td><input type="button" value="Clear Log and Results" id="clear_results_area"/></td></tr>
		<tr><td><table id="results_area" style="border:none;"/></td></tr>

	</table>
	</table>
</body>
</html>
